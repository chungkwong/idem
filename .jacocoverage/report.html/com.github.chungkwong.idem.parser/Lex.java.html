<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Lex.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;MIDE&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">com.github.chungkwong.idem.parser</a> &gt; <span class="el_source">Lex.java</span></div><h1>Lex.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2015 Chan Chung Kwong
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or (at
 * your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 */

package com.github.chungkwong.idem.parser;
import com.github.chungkwong.idem.lib.base.*;
import com.github.chungkwong.idem.math.*;
import java.io.*;
import java.math.*;
import java.util.*;
/**
 * A hand written lexical analyzer for Scheme(the intended target is R7RS small language)
 */
public final class Lex{
	public static final int EOF=-1,NONE=-2;
	public static final int ALARM='\u0007',BACKSPACE='\u0008',TABULATION='\u0009',LINEFEED='\n',NEWLINE='\n'
		,LINE_TABULATION='\u000B',FORM_FEED='\u000C',CARRIAGE_RETURN='\r',ESCAPE='\u001B',SPACE='\u0020'
		,DELETE='\u007F',NEXT_LINE='\u0085',LINE_SEPARATOR='\u2028',PARAGRAPH_SEPARATOR='\u2029';
<span class="nc" id="L30">	public static final HashMap&lt;String,Integer&gt; name2char=new HashMap&lt;&gt;();</span>
<span class="nc" id="L31">	public static final HashMap&lt;Integer,Integer&gt; mem2char=new HashMap&lt;&gt;();</span>
<span class="nc" id="L32">	public static final HashSet&lt;Integer&gt; delimiter=new HashSet&lt;&gt;();</span>
<span class="nc" id="L33">	public static final HashSet&lt;Integer&gt; idInitial=new HashSet&lt;&gt;(),idSubsequent=new HashSet&lt;&gt;();</span>
	//public static final HashSet&lt;Character&gt; expMarker=new HashSet&lt;Character&gt;();//R6RS only
<span class="nc" id="L35">	public static final HashSet&lt;Byte&gt; idInitialType=new HashSet&lt;&gt;(),idSubsequentType=new HashSet&lt;&gt;();</span>
	Reader in;
<span class="nc" id="L37">	boolean foldingCase=false;</span>
<span class="nc" id="L38">	int ugetc=NONE;//look forward charcater, NONE if none</span>
<span class="nc" id="L39">	HashMap&lt;String,Object&gt; datums=new HashMap&lt;&gt;();</span>
	static{
<span class="nc" id="L41">		name2char.put(&quot;null&quot;,(int)'\0');</span>
<span class="nc" id="L42">		name2char.put(&quot;alarm&quot;,ALARM);</span>
<span class="nc" id="L43">		name2char.put(&quot;backspace&quot;,BACKSPACE);</span>
<span class="nc" id="L44">		name2char.put(&quot;tab&quot;,TABULATION);</span>
<span class="nc" id="L45">		name2char.put(&quot;linefeed&quot;,LINEFEED);</span>
<span class="nc" id="L46">		name2char.put(&quot;newline&quot;,NEWLINE);</span>
<span class="nc" id="L47">		name2char.put(&quot;vtab&quot;,LINE_TABULATION);</span>
<span class="nc" id="L48">		name2char.put(&quot;page&quot;,FORM_FEED);</span>
<span class="nc" id="L49">		name2char.put(&quot;return&quot;,CARRIAGE_RETURN);</span>
<span class="nc" id="L50">		name2char.put(&quot;escape&quot;,ESCAPE);</span>
<span class="nc" id="L51">		name2char.put(&quot;space&quot;,SPACE);</span>
<span class="nc" id="L52">		name2char.put(&quot;delete&quot;,DELETE);</span>
<span class="nc" id="L53">		mem2char.put((int)'a',ALARM);</span>
<span class="nc" id="L54">		mem2char.put((int)'b',BACKSPACE);</span>
<span class="nc" id="L55">		mem2char.put((int)'t',TABULATION);</span>
<span class="nc" id="L56">		mem2char.put((int)'n',LINEFEED);</span>
<span class="nc" id="L57">		mem2char.put((int)'v',LINE_TABULATION);</span>
<span class="nc" id="L58">		mem2char.put((int)'f',FORM_FEED);</span>
<span class="nc" id="L59">		mem2char.put((int)'r',CARRIAGE_RETURN);</span>
<span class="nc" id="L60">		mem2char.put((int)'\&quot;',(int)'\&quot;');</span>
<span class="nc" id="L61">		mem2char.put((int)'\\',(int)'\\');</span>
<span class="nc" id="L62">		mem2char.put((int)'|',(int)'|');</span>
<span class="nc" id="L63">		delimiter.add((int)'(');</span>
<span class="nc" id="L64">		delimiter.add((int)')');</span>
<span class="nc" id="L65">		delimiter.add((int)'[');//for R6RS</span>
<span class="nc" id="L66">		delimiter.add((int)']');//for R6RS</span>
<span class="nc" id="L67">		delimiter.add((int)'\&quot;');</span>
<span class="nc" id="L68">		delimiter.add((int)'|');</span>
<span class="nc" id="L69">		delimiter.add((int)';');</span>
<span class="nc" id="L70">		idInitial.add((int)'!');</span>
<span class="nc" id="L71">		idInitial.add((int)'$');</span>
<span class="nc" id="L72">		idInitial.add((int)'%');</span>
<span class="nc" id="L73">		idInitial.add((int)'&amp;');</span>
<span class="nc" id="L74">		idInitial.add((int)'*');</span>
<span class="nc" id="L75">		idInitial.add((int)'/');</span>
<span class="nc" id="L76">		idInitial.add((int)':');</span>
<span class="nc" id="L77">		idInitial.add((int)'&lt;');</span>
<span class="nc" id="L78">		idInitial.add((int)'=');</span>
<span class="nc" id="L79">		idInitial.add((int)'&gt;');</span>
<span class="nc" id="L80">		idInitial.add((int)'?');</span>
<span class="nc" id="L81">		idInitial.add((int)'^');</span>
<span class="nc" id="L82">		idInitial.add((int)'_');</span>
<span class="nc" id="L83">		idInitial.add((int)'~');</span>
<span class="nc" id="L84">		idInitialType.add(Character.UPPERCASE_LETTER);</span>
<span class="nc" id="L85">		idInitialType.add(Character.LOWERCASE_LETTER);</span>
<span class="nc" id="L86">		idInitialType.add(Character.TITLECASE_LETTER);</span>
<span class="nc" id="L87">		idInitialType.add(Character.MODIFIER_LETTER);</span>
<span class="nc" id="L88">		idInitialType.add(Character.OTHER_LETTER);</span>
<span class="nc" id="L89">		idInitialType.add(Character.NON_SPACING_MARK);</span>
<span class="nc" id="L90">		idInitialType.add(Character.LETTER_NUMBER);</span>
<span class="nc" id="L91">		idInitialType.add(Character.OTHER_NUMBER);</span>
<span class="nc" id="L92">		idInitialType.add(Character.DASH_PUNCTUATION);</span>
<span class="nc" id="L93">		idInitialType.add(Character.CONNECTOR_PUNCTUATION);</span>
<span class="nc" id="L94">		idInitialType.add(Character.OTHER_PUNCTUATION);</span>
<span class="nc" id="L95">		idInitialType.add(Character.CURRENCY_SYMBOL);</span>
<span class="nc" id="L96">		idInitialType.add(Character.MATH_SYMBOL);</span>
<span class="nc" id="L97">		idInitialType.add(Character.MODIFIER_SYMBOL);</span>
<span class="nc" id="L98">		idInitialType.add(Character.OTHER_SYMBOL);</span>
<span class="nc" id="L99">		idInitialType.add(Character.PRIVATE_USE);</span>
<span class="nc" id="L100">		idSubsequent.addAll(idInitial);</span>
<span class="nc" id="L101">		idSubsequent.add((int)'+');</span>
<span class="nc" id="L102">		idSubsequent.add((int)'-');</span>
<span class="nc" id="L103">		idSubsequent.add((int)'.');</span>
<span class="nc" id="L104">		idSubsequent.add((int)'@');</span>
<span class="nc" id="L105">		idSubsequentType.addAll(idInitialType);</span>
<span class="nc" id="L106">		idSubsequentType.add(Character.DECIMAL_DIGIT_NUMBER);</span>
<span class="nc" id="L107">		idSubsequentType.add(Character.COMBINING_SPACING_MARK);</span>
<span class="nc" id="L108">		idSubsequentType.add(Character.ENCLOSING_MARK);</span>
		/*expMarker.add('e');
		expMarker.add('s');
		expMarker.add('f');
		expMarker.add('d');
		expMarker.add('l');
		expMarker.add('E');
		expMarker.add('S');
		expMarker.add('F');
		expMarker.add('D');
		expMarker.add('L');*/
<span class="nc" id="L119">	}</span>
	/**
	 * Construct a lexical analyzer to analysis a piece of code from a Reader
	 * @param in the source
	 */
<span class="nc" id="L124">	public Lex(Reader in){</span>
<span class="nc" id="L125">		this.in=in;</span>
<span class="nc" id="L126">	}</span>
	/**
	 * Construct a lexical analyzer to analysis a piece of code as String
	 * @param code the source
	 */
<span class="nc" id="L131">	public Lex(String code){</span>
<span class="nc" id="L132">		in=new StringReader(code);</span>
<span class="nc" id="L133">	}</span>
	/**
	 * Collect all remaining token
	 */
	public ArrayList&lt;Object&gt; getRemainingTokens()throws IOException{
<span class="nc" id="L138">		ArrayList&lt;Object&gt; tokens=new ArrayList&lt;Object&gt;();</span>
<span class="nc" id="L139">		Object next=nextToken();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">		while(next!=null){</span>
<span class="nc" id="L141">			tokens.add(next);</span>
<span class="nc" id="L142">			next=nextToken();</span>
		}
<span class="nc" id="L144">		return tokens;</span>
	}
	/**
	 * Get the next token
	 * @return the token or null if the end of the code is reached
	 */
	public Object nextToken(){
		try{
  			while(true){
<span class="nc" id="L153">				int c=ugetc;</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">				if(ugetc!=NONE)</span>
<span class="nc" id="L155">					ugetc=NONE;</span>
				else
<span class="nc" id="L157">					c=in.read();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">				if(isWhiteSpace(c))</span>
<span class="nc" id="L159">					continue;</span>
<span class="nc bnc" id="L160" title="All 8 branches missed.">				switch(c){</span>
					case EOF:
<span class="nc" id="L162">						return null;</span>
					case '(':case ')':case '`':case '\''://case '[':case ']':
<span class="nc" id="L164">						return new Token(String.valueOf((char)c));</span>
					case ',':
<span class="nc" id="L166">						ugetc=in.read();</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">						if(ugetc=='@')</span>
<span class="nc" id="L168">							return new Token(&quot;,@&quot;);</span>
						else{
<span class="nc" id="L170">							ugetc=NONE;</span>
<span class="nc" id="L171">							return new Token(&quot;,&quot;);</span>
						}
					case ';':
<span class="nc" id="L174">						eatLineRemaining();</span>
<span class="nc" id="L175">						break;</span>
					case '#':
<span class="nc" id="L177">						c=in.read();</span>
<span class="nc bnc" id="L178" title="All 9 branches missed.">						switch(c){</span>
							case '|':
<span class="nc" id="L180">								eatNestedComment();</span>
<span class="nc" id="L181">								break;</span>
							case '!':
<span class="nc bnc" id="L183" title="All 2 branches missed.">								foldingCase=in.read()=='f';</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">								if(foldingCase)</span>
<span class="nc" id="L185">									in.skip(8);//#!fold-case</span>
								else
<span class="nc" id="L187">									in.skip(11);//#!no-fold-case</span>
<span class="nc" id="L188">								break;</span>
							case ';':
<span class="nc" id="L190">								return new Token(&quot;#;&quot;);</span>
							case '\\':
<span class="nc" id="L192">								return nextCharacter();</span>
							case 't':case 'T':
<span class="nc" id="L194">								ugetc=in.read();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">								if(ugetc=='r'){</span>
<span class="nc" id="L196">									ugetc=NONE;</span>
<span class="nc" id="L197">									in.skip(3);//true</span>
								}
<span class="nc" id="L199">								return Boolean.TRUE;</span>
							case 'f':case 'F':
<span class="nc" id="L201">								ugetc=in.read();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">								if(ugetc=='a'){</span>
<span class="nc" id="L203">									ugetc=NONE;</span>
<span class="nc" id="L204">									in.skip(4);//false</span>
								}
<span class="nc" id="L206">								return Boolean.FALSE;</span>
							case '(':
<span class="nc" id="L208">								return new Token(&quot;#(&quot;);</span>
							case 'u':
<span class="nc bnc" id="L210" title="All 4 branches missed.">								if(in.read()=='8'&amp;&amp;in.read()=='(')</span>
<span class="nc" id="L211">									return new Token(&quot;#u8(&quot;);</span>
							/*case '\'':
								return new Token(&quot;#\'&quot;);
							case '`':
								return new Token(&quot;#`&quot;);
							case ',':
								if(curr+1&lt;len&amp;&amp;code.charAt(curr+1)=='@'){
									++curr;
									return new Token(&quot;#,@&quot;);
								}else
									return new Token(&quot;#,&quot;);
							case 'v':
								if(curr+3&lt;=len&amp;&amp;code.substring(curr,curr+3).equals(&quot;u8(&quot;)){
									curr+=3;
									return new Token(&quot;#vu8(&quot;);
								}
								break;*/
							default:
<span class="nc bnc" id="L229" title="All 2 branches missed.">								if(Character.isLetter(c)){</span>
<span class="nc" id="L230">									ugetc=c;</span>
<span class="nc" id="L231">									return nextNumber('#');</span>
									}
<span class="nc" id="L233">									return nextLabel();</span>
						}
						break;
					case '\&quot;':
<span class="nc" id="L237">						return nextString();</span>
					case '|':
<span class="nc" id="L239">						return nextVerbatimIdentifer();</span>
					default:
<span class="nc" id="L241">						return nextIdentiferOrNumber(c);</span>
				}
<span class="nc" id="L243">			}</span>
<span class="nc" id="L244">		}catch(IOException ex){</span>
<span class="nc" id="L245">			return new RuntimeException(&quot;Exception while reading token&quot;);</span>
		}
	}
	static final boolean isWhiteSpace(int c){
<span class="nc bnc" id="L249" title="All 2 branches missed.">		switch(c){</span>
			case TABULATION:
			case LINEFEED:
			case CARRIAGE_RETURN:
			case LINE_TABULATION:
			case FORM_FEED:
			case NEXT_LINE:
<span class="nc" id="L256">				return true;</span>
		}
<span class="nc" id="L258">		int type=Character.getType(c);</span>
<span class="nc bnc" id="L259" title="All 6 branches missed.">		if(type==Character.SPACE_SEPARATOR||type==Character.LINE_SEPARATOR||type==Character.PARAGRAPH_SEPARATOR)</span>
<span class="nc" id="L260">			return true;</span>
<span class="nc" id="L261">		return false;</span>
	}
	static final boolean isDelimiter(int c){
<span class="nc bnc" id="L264" title="All 4 branches missed.">		return delimiter.contains(c)||isWhiteSpace(c);</span>
	}
	void eatLineRemaining()throws IOException{
<span class="nc" id="L267">		int c=in.read();</span>
<span class="nc bnc" id="L268" title="All 12 branches missed.">		while(c!=EOF&amp;&amp;c!=LINEFEED&amp;&amp;c!=CARRIAGE_RETURN&amp;&amp;c!=NEXT_LINE&amp;&amp;c!=LINE_SEPARATOR&amp;&amp;c!=PARAGRAPH_SEPARATOR)</span>
<span class="nc" id="L269">			c=in.read();</span>
<span class="nc" id="L270">	}</span>
	void eatNestedComment()throws IOException{
<span class="nc" id="L272">		int lv=1;</span>
		int ch;
<span class="nc bnc" id="L274" title="All 2 branches missed.">		while((ch=in.read())!=EOF){</span>
<span class="nc bnc" id="L275" title="All 4 branches missed.">			if(ch=='#'&amp;&amp;in.read()=='|'){</span>
<span class="nc" id="L276">				++lv;</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">			}else if(ch=='|'&amp;&amp;in.read()=='#'){</span>
<span class="nc" id="L278">				--lv;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">				if(lv==0)</span>
<span class="nc" id="L280">					break;</span>
			}
		}
<span class="nc" id="L283">	}</span>
	char nextCharacter()throws IOException{
<span class="nc" id="L285">		String cname=untilNextDelimiter();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">		if(cname.length()==1)</span>
<span class="nc" id="L287">			return cname.charAt(0);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">		else if(cname.charAt(0)=='x'){//&amp;&amp;cname.length()&gt;1</span>
<span class="nc" id="L289">			ugetc=NONE;//forget the ';' after the hex</span>
<span class="nc" id="L290">			return Character.toChars(Integer.valueOf(cname.substring(1),16))[0];</span>
		}else{
<span class="nc bnc" id="L292" title="All 2 branches missed.">			if(foldingCase)</span>
<span class="nc" id="L293">				cname=ScmString.toFoldingCase(cname);</span>
<span class="nc" id="L294">			return (char)(int)name2char.get(cname);</span>
		}
	}
	String untilNextDelimiter()throws IOException{
<span class="nc" id="L298">		StringBuilder buf=new StringBuilder();</span>
<span class="nc" id="L299">		buf.append((char)in.read());</span>
		int c;
<span class="nc bnc" id="L301" title="All 6 branches missed.">		while((c=in.read())!=EOF&amp;&amp;!isDelimiter(c)&amp;&amp;c!='#'){</span>
<span class="nc" id="L302">			buf.append((char)c);</span>
		}
<span class="nc" id="L304">		ugetc=c;</span>
<span class="nc" id="L305">		return buf.toString();</span>
	}
	DatumLabel nextLabel()throws IOException{
<span class="nc" id="L308">		StringBuilder buf=new StringBuilder();</span>
		while(true){
<span class="nc" id="L310">			int c=in.read();</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if(c=='=')</span>
<span class="nc" id="L312">				return new DatumLabelSrc(buf.toString());</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">			else if(c=='#')</span>
<span class="nc" id="L314">				return new DatumLabelRef(buf.toString());</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">			else if(Character.isDigit(c))</span>
<span class="nc" id="L316">				buf.append((char)c);</span>
			else
<span class="nc" id="L318">				throw new RuntimeException(&quot;Illegal label format&quot;);</span>
<span class="nc" id="L319">		}</span>
	}
	String nextString() throws IOException{
<span class="nc" id="L322">		StringBuilder str=new StringBuilder();</span>
<span class="nc" id="L323">		int c=in.read();</span>
		while(true){
<span class="nc bnc" id="L325" title="All 2 branches missed.">			if(c=='\\'){</span>
<span class="nc" id="L326">				c=in.read();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">				if(mem2char.containsKey(c)){</span>
<span class="nc" id="L328">					str.append((char)(int)mem2char.get(c));</span>
<span class="nc" id="L329">					c=in.read();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">				}else if(c=='x'){</span>
<span class="nc" id="L331">					int point=0;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">					while((c=in.read())!=';')</span>
<span class="nc" id="L333">						point=point*16+Character.digit(c,16);</span>
<span class="nc" id="L334">					str.append((char)point);</span>
<span class="nc" id="L335">					c=in.read();</span>
<span class="nc" id="L336">				}else{</span>
<span class="nc" id="L337">					c=eatLineEndingInString(c);</span>
				}
<span class="nc bnc" id="L339" title="All 2 branches missed.">			}else if(c=='\&quot;'){</span>
<span class="nc" id="L340">				break;</span>
			}else{
<span class="nc" id="L342">				str.append((char)c);</span>
<span class="nc" id="L343">				c=in.read();</span>
			}
		}
<span class="nc" id="L346">		return str.toString();</span>
	}
	int eatLineEndingInString(int c)throws IOException{
<span class="nc bnc" id="L349" title="All 4 branches missed.">		while(c!=EOF&amp;&amp;isIntraLineSpace(c))</span>
<span class="nc" id="L350">			c=in.read();</span>
<span class="nc bnc" id="L351" title="All 3 branches missed.">		switch(c){</span>
			case LINEFEED:
			case NEXT_LINE:
			case LINE_SEPARATOR:
<span class="nc" id="L355">				c=in.read();</span>
<span class="nc" id="L356">				break;</span>
			case CARRIAGE_RETURN:
<span class="nc" id="L358">				c=in.read();</span>
<span class="nc bnc" id="L359" title="All 4 branches missed.">				if(c==LINEFEED||c==NEXT_LINE)</span>
<span class="nc" id="L360">					c=in.read();</span>
				break;
			default:
<span class="nc" id="L363">				throw new RuntimeException(&quot;Illegal string format&quot;);</span>
		}
<span class="nc bnc" id="L365" title="All 4 branches missed.">		while(c!=EOF&amp;&amp;isIntraLineSpace(c))</span>
<span class="nc" id="L366">			c=in.read();</span>
<span class="nc" id="L367">		return c;</span>
	}
	static final boolean isIntraLineSpace(int c){
<span class="nc bnc" id="L370" title="All 4 branches missed.">		return c==TABULATION||Character.getType(c)==Character.SPACE_SEPARATOR;</span>
	}
	String nextVerbatimIdentifer()throws IOException{
<span class="nc" id="L373">		int c=in.read();</span>
<span class="nc" id="L374">		StringBuilder buf=new StringBuilder();</span>
<span class="nc bnc" id="L375" title="All 4 branches missed.">		while(c!='|'&amp;&amp;c!=EOF){</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">			if(c=='\\'){</span>
<span class="nc" id="L377">				c=nextHexOrMem(buf);</span>
			}else{
<span class="nc" id="L379">				buf.append((char)c);</span>
<span class="nc" id="L380">				c=in.read();</span>
			}
		}
<span class="nc bnc" id="L383" title="All 2 branches missed.">		return foldingCase?ScmString.toFoldingCase(buf.toString()):buf.toString();</span>
	}
	int nextHexOrMem(StringBuilder buf)throws IOException{
<span class="nc" id="L386">		int c=in.read();</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">		if(mem2char.containsKey((char)c))</span>
<span class="nc" id="L388">			return mem2char.get((char)c);</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">		else if(c=='x'){</span>
<span class="nc" id="L390">			int point=0;</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">			while((c=in.read())!=';'){</span>
<span class="nc" id="L392">				point=point*16+Character.digit(c,16);</span>
			}
<span class="nc" id="L394">			buf.append((char)point);</span>
<span class="nc" id="L395">			return c;</span>
		}else{
<span class="nc" id="L397">			return c;</span>
		}
	}
	Object nextIdentiferOrNumber(int prefix)throws IOException{
<span class="nc bnc" id="L401" title="All 2 branches missed.">		if(isInitial(prefix))</span>
<span class="nc" id="L402">			return nextIdentifer(prefix);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">		if(prefix=='.'){</span>
<span class="nc" id="L404">			ugetc=in.read();</span>
<span class="nc bnc" id="L405" title="All 4 branches missed.">			if(ugetc==EOF||isDelimiter(ugetc)){</span>
<span class="nc" id="L406">				return new Token(&quot;.&quot;);</span>
			}
<span class="nc bnc" id="L408" title="All 10 branches missed.">			if(ugetc=='.'||ugetc=='+'||ugetc=='-'||ugetc=='@'||isInitial(ugetc))</span>
<span class="nc" id="L409">				return nextIdentifer(prefix);</span>
<span class="nc bnc" id="L410" title="All 4 branches missed.">		}else if(prefix=='+'||prefix=='-'){</span>
<span class="nc" id="L411">			ugetc=in.read();</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">			if(ugetc==EOF||isDelimiter(ugetc)){</span>
<span class="nc" id="L413">				return Character.toString((char)prefix);</span>
			}
			//TODO support of identifier likes +.(.)
<span class="nc bnc" id="L416" title="All 8 branches missed.">			if(ugetc=='+'||ugetc=='-'||ugetc=='@'||isInitial(ugetc))</span>
<span class="nc" id="L417">				return nextIdentifer(prefix);</span>
		}
<span class="nc" id="L419">		return nextNumber(prefix);</span>
	}
	String nextIdentifer(int prefix)throws IOException{
<span class="nc" id="L422">		StringBuilder str=new StringBuilder();</span>
<span class="nc" id="L423">		str.append((char)prefix);</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">		if(ugetc!=NONE)</span>
<span class="nc" id="L425">			prefix=ugetc;</span>
		else
<span class="nc" id="L427">			prefix=in.read();</span>
<span class="nc bnc" id="L428" title="All 4 branches missed.">		while(prefix!=EOF&amp;&amp;isSubsequent(prefix)){</span>
<span class="nc" id="L429">			str.append((char)prefix);</span>
<span class="nc" id="L430">			prefix=in.read();</span>
		}
<span class="nc" id="L432">		ugetc=prefix;</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">		return foldingCase?ScmString.toFoldingCase(str.toString()):str.toString();</span>
	}
	static final boolean isInitial(int c){
<span class="nc bnc" id="L436" title="All 14 branches missed.">		return (c&gt;='a'&amp;&amp;c&lt;='z')||(c&gt;='A'&amp;&amp;c&lt;='Z')||idInitial.contains(c)||(c&gt;127&amp;&amp;idInitialType.contains(Character.getType(c)));</span>
	}
	static final boolean isSubsequent(int c){
<span class="nc bnc" id="L439" title="All 18 branches missed.">		return (c&gt;='a'&amp;&amp;c&lt;='z')||(c&gt;='A'&amp;&amp;c&lt;='Z')||(c&gt;='0'&amp;&amp;c&lt;='9')||idSubsequent.contains(c)||(c&gt;127&amp;&amp;idSubsequentType.contains(Character.getType(c)));</span>
	}
	Object nextNumber(int prefix)throws IOException{
<span class="nc" id="L442">		int base=10;</span>
<span class="nc" id="L443">		byte exact=0;//1 mean exact, -1 means inexact,0 means not mentioned</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">		if(prefix=='#'){</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">			for(int i=0;i&lt;2;i++){</span>
<span class="nc bnc" id="L446" title="All 7 branches missed.">				switch(ugetc){</span>
					case 'i':case 'I':
<span class="nc" id="L448">						exact=-1;</span>
<span class="nc" id="L449">						break;</span>
					case 'e':case 'E':
<span class="nc" id="L451">						exact=1;</span>
<span class="nc" id="L452">						break;</span>
					case 'b':case 'B':
<span class="nc" id="L454">						base=2;</span>
<span class="nc" id="L455">						break;</span>
					case 'o':case 'O':
<span class="nc" id="L457">						base=8;</span>
<span class="nc" id="L458">						break;</span>
					case 'd':case 'D':
<span class="nc" id="L460">						base=10;</span>
<span class="nc" id="L461">						break;</span>
					case 'x':case 'X':
<span class="nc" id="L463">						base=16;</span>
						break;
				}
<span class="nc" id="L466">				prefix=in.read();</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">				if(prefix=='#')</span>
<span class="nc" id="L468">					ugetc=in.read();</span>
				else
					break;
			}
<span class="nc" id="L472">			ugetc=NONE;</span>
		}
<span class="nc" id="L474">		Object real=nextReal(prefix,exact,base);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">		if(ugetc==NONE){</span>
<span class="nc" id="L476">			prefix=in.read();</span>
		}else{
<span class="nc" id="L478">			prefix=ugetc;</span>
<span class="nc" id="L479">			ugetc=NONE;</span>
		}
<span class="nc bnc" id="L481" title="All 4 branches missed.">		switch(prefix){</span>
			case 'i':
<span class="nc" id="L483">				return new Tuple(BigInteger.ZERO,real);</span>
			case '@':
<span class="nc" id="L485">				return new Tuple(real,nextReal(in.read(),exact,base));</span>
			case '+':
			case '-':
<span class="nc" id="L488">				ugetc=in.read();</span>
<span class="nc" id="L489">				Object imag=nextReal(prefix,exact,base);</span>
<span class="nc" id="L490">				ugetc=NONE;</span>
<span class="nc" id="L491">				return new Tuple(real,imag);</span>
			default:
<span class="nc" id="L493">				ugetc=prefix;</span>
<span class="nc" id="L494">				return real;</span>
		}
	}
	Object nextReal(int prefix,byte exact,int base)throws IOException{
<span class="nc" id="L498">		boolean neg=false;</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">		if(prefix=='+'){</span>
<span class="nc" id="L500">			prefix=ugetc;</span>
<span class="nc" id="L501">			ugetc=NONE;</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">		}else if(prefix=='-'){</span>
<span class="nc" id="L503">			neg=true;</span>
<span class="nc" id="L504">			prefix=ugetc;</span>
<span class="nc" id="L505">			ugetc=NONE;</span>
		}
<span class="nc bnc" id="L507" title="All 2 branches missed.">		if(prefix=='i'){</span>
<span class="nc" id="L508">			ugetc=prefix;</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">			return neg?BigInteger.ONE.negate():BigInteger.ONE;</span>
		}
<span class="nc" id="L511">		BigInteger num=BigInteger.ZERO,b=BigInteger.valueOf(base);</span>
<span class="nc" id="L512">		DigitVerifier digitCheck=DigitVerifier.getDigitVerifier(base);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">		while(digitCheck.verify(prefix)){</span>
<span class="nc" id="L514">			num=num.multiply(b).add(BigInteger.valueOf(Character.digit(prefix,base)));</span>
<span class="nc" id="L515">			prefix=in.read();</span>
		}
<span class="nc" id="L517">		BigDecimal real=null;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if(prefix=='.'){</span>
<span class="nc" id="L519">			BigDecimal ratio=BigDecimal.ONE.divide(BigDecimal.valueOf(base)),pos=ratio;</span>
<span class="nc" id="L520">			real=new BigDecimal(num);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">			prefix=ugetc!=NONE?ugetc:in.read();</span>
<span class="nc" id="L522">			ugetc=NONE;</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">			while(digitCheck.verify(prefix)){</span>
<span class="nc" id="L524">				real=BigDecimal.valueOf(Character.digit(prefix,base)).multiply(pos).add(real);</span>
<span class="nc" id="L525">				pos=pos.multiply(ratio);</span>
<span class="nc" id="L526">				prefix=in.read();</span>
			}
<span class="nc bnc" id="L528" title="All 2 branches missed.">		}else if(prefix=='/'){</span>
<span class="nc" id="L529">			BigInteger dorm=BigInteger.ZERO;</span>
<span class="nc" id="L530">			prefix=in.read();</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">			while(digitCheck.verify(prefix)){</span>
<span class="nc" id="L532">				dorm=dorm.multiply(b).add(BigInteger.valueOf(Character.digit(prefix,base)));</span>
<span class="nc" id="L533">				prefix=in.read();</span>
			}
<span class="nc" id="L535">			ugetc=prefix;</span>
<span class="nc" id="L536">			return new Rational(num,dorm);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">		}else if(prefix=='i'){</span>
<span class="nc" id="L538">			in.skip(4);//inf.0</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">			return neg?Double.NEGATIVE_INFINITY:Double.POSITIVE_INFINITY;</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">		}else if(prefix=='n'){</span>
<span class="nc" id="L541">			in.skip(4);//nan.0</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">			return neg?-Double.NaN:Double.NaN;</span>
		}
<span class="nc bnc" id="L544" title="All 2 branches missed.">		if(prefix=='e'){</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">			if(real==null)</span>
<span class="nc" id="L546">				real=new BigDecimal(num);</span>
<span class="nc" id="L547">			prefix=in.read();</span>
<span class="nc" id="L548">			boolean negexp=false;</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">			if(prefix=='+'){</span>
<span class="nc" id="L550">				prefix=in.read();</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">			}else if(prefix=='-'){</span>
<span class="nc" id="L552">				negexp=true;</span>
<span class="nc" id="L553">				prefix=in.read();</span>
			}
<span class="nc" id="L555">			int exp=0;</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">			while(Character.isDigit(prefix)){</span>
<span class="nc" id="L557">				exp=exp*10+Character.digit(prefix,10);</span>
<span class="nc" id="L558">				prefix=in.read();</span>
			}
<span class="nc bnc" id="L560" title="All 2 branches missed.">			real=real.movePointRight(negexp?-exp:exp);</span>
		}
<span class="nc" id="L562">		ugetc=prefix;</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">		if(real==null)</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">			return neg?num.negate():num;</span>
		else
<span class="nc bnc" id="L566" title="All 2 branches missed.">			return neg?real.negate():real;</span>
	}
	public static void main(String[] args)throws IOException{
<span class="nc" id="L569">		BufferedReader in=new BufferedReader(new InputStreamReader(System.in));</span>
<span class="nc" id="L570">		String s=null;</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">		while((s=in.readLine())!=null){</span>
<span class="nc" id="L572">			System.out.println(new Lex(s).getRemainingTokens());</span>
		}
<span class="nc" id="L574">	}</span>
}
class DigitVerifier{
<span class="nc" id="L577">	BitSet digits=new BitSet(128);</span>
<span class="nc" id="L578">	static final DigitVerifier[] loaded=new DigitVerifier[37];</span>
<span class="nc" id="L579">	private DigitVerifier(int base){</span>
<span class="nc bnc" id="L580" title="All 4 branches missed.">		if(base&lt;2||base&gt;36)</span>
<span class="nc" id="L581">			throw new RuntimeException();</span>
<span class="nc" id="L582">		digits.set('0','0'+Math.min(10,base));</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">		if(base&gt;10){</span>
<span class="nc" id="L584">			digits.set('a','a'+(base-10));</span>
<span class="nc" id="L585">			digits.set('A','A'+(base-10));</span>
		}
<span class="nc" id="L587">	}</span>
	public static DigitVerifier getDigitVerifier(int base){
<span class="nc bnc" id="L589" title="All 2 branches missed.">		if(loaded[base]==null)</span>
<span class="nc" id="L590">			loaded[base]=new DigitVerifier(base);</span>
<span class="nc" id="L591">		return loaded[base];</span>
	}
	public boolean verify(int c){
<span class="nc bnc" id="L594" title="All 4 branches missed.">		if(c&gt;127||c&lt;0)</span>
<span class="nc" id="L595">			return false;</span>
<span class="nc" id="L596">		return digits.get(c);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>