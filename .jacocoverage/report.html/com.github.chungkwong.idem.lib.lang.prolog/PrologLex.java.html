<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PrologLex.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;MIDE&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">com.github.chungkwong.idem.lib.lang.prolog</a> &gt; <span class="el_source">PrologLex.java</span></div><h1>PrologLex.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2016 Chan Chung Kwong &lt;1m02math@126.com&gt;
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package com.github.chungkwong.idem.lib.lang.prolog;
import static com.github.chungkwong.idem.global.Log.LOG;
import com.github.chungkwong.idem.lib.*;
import java.io.*;
import java.math.*;
import java.util.*;
/**
 *
 * @author kwong
 */
public class PrologLex implements SimpleIterator&lt;Object&gt;{
	PushbackReader in;
	static final String GRAPHIC_TOKEN_CHARACTER=&quot;#$&amp;*+-./:&lt;=&gt;?@^~\\&quot;;
<span class="fc" id="L30">	public PrologLex(Reader in){</span>
<span class="fc" id="L31">		this.in=new PushbackReader(in,2);</span>
<span class="fc" id="L32">	}</span>
	public PrologLex(String code){
<span class="fc" id="L34">		this(new StringReader(code));</span>
<span class="fc" id="L35">	}</span>
	public ArrayList&lt;Object&gt; getRemainingTokens()throws IOException{
<span class="nc" id="L37">		ArrayList&lt;Object&gt; tokens=new ArrayList&lt;&gt;();</span>
<span class="nc" id="L38">		Object next=nextToken();</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">		while(next!=null){</span>
<span class="nc" id="L40">			tokens.add(next);</span>
<span class="nc" id="L41">			next=nextToken();</span>
		}
<span class="nc" id="L43">		return tokens;</span>
	}
	private void unreadIfNotEOF(int c) throws IOException{
<span class="fc bfc" id="L46" title="All 2 branches covered.">		if(c!=-1)</span>
<span class="fc" id="L47">			in.unread(c);</span>
<span class="fc" id="L48">	}</span>
	private void eatLayoutText()throws IOException{
		while(true){
<span class="fc" id="L51">			int c=in.read();</span>
<span class="fc bfc" id="L52" title="All 5 branches covered.">			switch(c){</span>
				case ' ':case '\r':case '\n':
<span class="fc" id="L54">					break;</span>
				case '%':
<span class="fc bfc" id="L56" title="All 6 branches covered.">					while(c!=-1&amp;&amp;c!='\n'&amp;&amp;c!='\r'){</span>
<span class="fc" id="L57">						c=in.read();</span>
					}
					break;
				case '/':
<span class="fc" id="L61">					c=in.read();</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">					if(c=='*'){</span>
						bracket:while(true){
<span class="fc" id="L64">							c=in.read();</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">							if(c==-1)</span>
<span class="nc" id="L66">								throw new LexicalException(&quot;comment not ended&quot;);</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">							while(c=='*'){</span>
<span class="fc" id="L68">								c=in.read();</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">								if(c=='/')</span>
<span class="fc" id="L70">									break bracket;</span>
							}
						}
					}else{
<span class="fc" id="L74">						in.unread('/');</span>
<span class="fc" id="L75">						unreadIfNotEOF(c);</span>
<span class="fc" id="L76">						return;</span>
					}
					break;
				case -1:
<span class="fc" id="L80">					return;</span>
				default:
<span class="fc" id="L82">					in.unread(c);</span>
<span class="fc" id="L83">					return;</span>
			}
<span class="fc" id="L85">		}</span>
	}
	private char getChar(int base)throws IOException{
<span class="fc" id="L88">		int c=in.read(),ch=0;</span>
<span class="pc bpc" id="L89" title="1 of 4 branches missed.">		while(c!='\\'&amp;&amp;c!=-1){</span>
<span class="fc" id="L90">			ch=ch*base+Character.digit(c,base);</span>
<span class="fc" id="L91">			c=in.read();</span>
		}
<span class="fc" id="L93">		return (char)ch;</span>
	}
	private char getEspaceCharacter() throws IOException{
<span class="fc" id="L96">		int c=in.read();</span>
<span class="pc bpc" id="L97" title="1 of 13 branches missed.">		switch(c){</span>
			case '\\':case '`':case '\'':case '\&quot;':
<span class="fc" id="L99">				return (char)c;</span>
			case 'a':
<span class="fc" id="L101">				return '\u0007';</span>
			case 'b':
<span class="fc" id="L103">				return '\b';</span>
			case 'f':
<span class="fc" id="L105">				return '\f';</span>
			case 'n':
<span class="fc" id="L107">				return '\n';</span>
			case 'r':
<span class="fc" id="L109">				return '\r';</span>
			case 't':
<span class="fc" id="L111">				return '\t';</span>
			case 'v':
<span class="fc" id="L113">				return '\u000B';</span>
			case 'x':
<span class="fc" id="L115">				return getChar(16);</span>
			case '\r':
<span class="fc" id="L117">				c=in.read();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">				if(c!='\n')</span>
<span class="fc" id="L119">					unreadIfNotEOF(c);</span>
			case '\n':
<span class="fc" id="L121">				return '\0';</span>
			case -1:
<span class="nc" id="L123">				throw new LexicalException(&quot;reached end of the stream&quot;);</span>
			default:
<span class="fc" id="L125">				in.unread(c);</span>
<span class="fc" id="L126">				return getChar(8);</span>
		}
	}
	private String getQuotedString(char quote) throws IOException{
<span class="fc" id="L130">		StringBuilder buf=new StringBuilder();</span>
		while(true){
<span class="fc" id="L132">			int c=in.read();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">			if(c==quote){</span>
<span class="fc" id="L134">				c=in.read();</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">				if(c==quote)</span>
<span class="fc" id="L136">					buf.append(quote);</span>
				else{
<span class="fc" id="L138">					unreadIfNotEOF(c);</span>
<span class="fc" id="L139">					break;</span>
				}
<span class="fc bfc" id="L141" title="All 2 branches covered.">			}else if(c=='\\'){</span>
<span class="fc" id="L142">				char esc=getEspaceCharacter();</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">				if(esc!='\0')</span>
<span class="nc" id="L144">					buf.append(esc);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">			}else if(c==-1)</span>
<span class="nc" id="L146">				break;</span>
			else
<span class="fc" id="L148">				buf.append((char)c);</span>
<span class="fc" id="L149">		}</span>
<span class="fc" id="L150">		return buf.toString();</span>
	}
	private String getGraphicToken(int start) throws IOException{
<span class="fc" id="L153">		StringBuilder buf=new StringBuilder();</span>
<span class="fc" id="L154">		buf.append((char)start);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">		while(GRAPHIC_TOKEN_CHARACTER.indexOf(start=in.read())!=-1)</span>
<span class="fc" id="L156">			buf.append((char)start);</span>
<span class="fc" id="L157">		unreadIfNotEOF(start);</span>
<span class="fc" id="L158">		return buf.toString();</span>
	}
	private Variable getVariable() throws IOException{
<span class="fc" id="L161">		int c=in.read();</span>
<span class="fc bfc" id="L162" title="All 4 branches covered.">		if(Character.isAlphabetic(c)||Character.isDigit(c)){</span>
<span class="fc" id="L163">			StringBuilder buf=new StringBuilder();</span>
<span class="fc" id="L164">			buf.append('_');</span>
			do{
<span class="fc" id="L166">				buf.append((char)c);</span>
<span class="fc" id="L167">				c=in.read();</span>
<span class="fc bfc" id="L168" title="All 4 branches covered.">			}while(Character.isAlphabetic(c)||Character.isDigit(c));</span>
<span class="fc" id="L169">			unreadIfNotEOF(c);</span>
<span class="fc" id="L170">			return new Variable(buf.toString());</span>
		}else{
<span class="fc" id="L172">			unreadIfNotEOF(c);</span>
<span class="fc" id="L173">			return Variable.WILDCARD;</span>
		}
	}
	private Object getIdentifier(int start) throws IOException{
<span class="fc" id="L177">		StringBuilder buf=new StringBuilder();</span>
<span class="fc bfc" id="L178" title="All 4 branches covered.">		while(Character.isLetter(start)||Character.isDigit(start)){</span>
<span class="fc" id="L179">			buf.append((char)start);</span>
<span class="fc" id="L180">			start=in.read();</span>
		}
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">		if(buf.length()==0)</span>
<span class="nc" id="L183">			throw new LexicalException(&quot;Unknown token&quot;);</span>
<span class="fc" id="L184">		unreadIfNotEOF(start);</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">		if(Character.isUpperCase(buf.charAt(0))){</span>
<span class="fc" id="L186">			return new Variable(buf.toString());</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">		}else if(Character.isLowerCase(buf.charAt(0))){</span>
<span class="fc" id="L188">			return buf.toString();</span>
		}else
<span class="nc" id="L190">			throw new LexicalException(&quot;Identifier token or named variable expected&quot;);</span>
	}
	private BigInteger getInteger(int base) throws IOException{
<span class="fc" id="L193">		StringBuilder buf=new StringBuilder();</span>
<span class="fc" id="L194">		int c=in.read();</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">		while(Character.digit(c,base)!=-1){</span>
<span class="fc" id="L196">			buf.append((char)c);</span>
<span class="fc" id="L197">			c=in.read();</span>
		}
<span class="fc" id="L199">		unreadIfNotEOF(c);</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">		if(buf.length()==0)</span>
<span class="fc" id="L201">			return BigInteger.ZERO;</span>
		else
<span class="fc" id="L203">			return new BigInteger(buf.toString(),base);</span>
	}
	private Number getNumber(int start) throws IOException{
<span class="fc bfc" id="L206" title="All 2 branches covered.">		if(start=='0'){</span>
<span class="fc" id="L207">			start=in.read();</span>
<span class="fc bfc" id="L208" title="All 5 branches covered.">			switch(start){</span>
				case 'b':
<span class="fc" id="L210">					return getInteger(2);</span>
				case 'o':
<span class="fc" id="L212">					return getInteger(8);</span>
				case 'x':
<span class="fc" id="L214">					return getInteger(16);</span>
				case '\'':
<span class="fc" id="L216">					start=in.read();</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">					if(start=='\'')</span>
<span class="fc" id="L218">						in.read();</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">					else if(start=='\\')</span>
<span class="fc" id="L220">						start=getEspaceCharacter();</span>
<span class="fc" id="L221">					return BigInteger.valueOf(start);</span>
			}
		}
<span class="fc" id="L224">		unreadIfNotEOF(start);</span>
<span class="fc" id="L225">		BigInteger intPart=getInteger(10);</span>
<span class="fc" id="L226">		start=in.read();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">		if(start=='.'){</span>
<span class="fc" id="L228">			int offset=0;</span>
<span class="fc" id="L229">			BigDecimal val=new BigDecimal(intPart),pos=BigDecimal.ONE.movePointLeft(1);</span>
<span class="fc" id="L230">			start=in.read();</span>
<span class="fc bfc" id="L231" title="All 4 branches covered.">			while(start&gt;='0'&amp;&amp;start&lt;='9'){</span>
<span class="fc" id="L232">				val=val.add(BigDecimal.valueOf(start-'0').multiply(pos));</span>
<span class="fc" id="L233">				pos=pos.movePointLeft(1);</span>
<span class="fc" id="L234">				start=in.read();</span>
			}
<span class="fc bfc" id="L236" title="All 4 branches covered.">			if(start=='E'||start=='e'){</span>
<span class="fc" id="L237">				start=in.read();</span>
<span class="fc" id="L238">				boolean neg=false;</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">				if(start=='-')</span>
<span class="fc" id="L240">					neg=true;</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">				else if(start==-1)</span>
<span class="nc" id="L242">					throw new LexicalException(&quot;Number not ended&quot;);</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">				else if(start!='+')</span>
<span class="fc" id="L244">					in.unread(start);</span>
<span class="fc" id="L245">				int expPart=getInteger(10).intValue();</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">				val=neg?val.movePointLeft(expPart):val.movePointRight(expPart);</span>
<span class="fc" id="L247">			}else</span>
<span class="fc" id="L248">				unreadIfNotEOF(start);</span>
<span class="fc" id="L249">			return val;</span>
		}else{
<span class="fc" id="L251">			unreadIfNotEOF(start);</span>
<span class="fc" id="L252">			return intPart;</span>
		}
	}
	public Object nextToken()throws IOException{
<span class="fc" id="L256">		eatLayoutText();</span>
<span class="fc" id="L257">		int c=in.read();</span>
<span class="fc bfc" id="L258" title="All 9 branches covered.">		switch(c){</span>
			case'(':case')':case'[':case ']':case '{':case '}':case '|':case ',':case ';':case '!':
<span class="fc" id="L260">				return String.valueOf((char)c);</span>
			case '`':
<span class="fc" id="L262">				return getQuotedString('`');</span>
			case '\'':
<span class="fc" id="L264">				return getQuotedString('\'');</span>
			case '\&quot;':
<span class="fc" id="L266">				return getQuotedString('\&quot;');</span>
			case '.':case '#':case '$': case '&amp;':case '*':case '+':case '-':case '/':case ':':
			case '&lt;':case '=':case '&gt;':case '?':case '@':case '^':case '~':case '\\':
<span class="fc" id="L269">				return getGraphicToken(c);</span>
			case '_':
<span class="fc" id="L271">				return getVariable();</span>
			case '0':case '1':case '2':case '3':case '4':case '5':case '6':case '7':case '8':case '9':
<span class="fc" id="L273">				return getNumber(c);</span>
			case -1:
<span class="fc" id="L275">				return null;</span>
			default:
<span class="fc" id="L277">				return getIdentifier(c);</span>
		}
	}
	@Override
	public Object next(){
		try{
<span class="fc" id="L283">			return nextToken();</span>
<span class="nc" id="L284">		}catch(IOException ex){</span>
<span class="nc" id="L285">			LOG.log(java.util.logging.Level.SEVERE,&quot;Reach end of stream&quot;,ex);</span>
		}
<span class="nc" id="L287">		return null;</span>
	}
	public static void main(String[] args) throws IOException{
<span class="nc" id="L290">		Scanner in=new Scanner(System.in);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">		while(in.hasNextLine()){</span>
<span class="nc" id="L292">			PrologLex lex=new PrologLex(in.nextLine());</span>
<span class="nc" id="L293">			System.out.println(lex.getRemainingTokens());</span>
<span class="nc" id="L294">		}</span>
<span class="nc" id="L295">	}</span>
}
class LexicalException extends RuntimeException{
	public LexicalException(String message){
<span class="nc" id="L299">		super(message);</span>
<span class="nc" id="L300">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>